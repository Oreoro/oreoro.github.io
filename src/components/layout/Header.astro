---
import Search from "@/components/ui/Search.astro";
import ThemeIcon from "@/components/ui/ThemeIcon.astro";
import { getMenu } from "@/utils";
import { siteInfo } from "@/site.config";
import { getNavLink, normalizeNavPath } from "@/lib/blog-helpers";
import Icon from "@/components/ui/Icon.astro";

const menuLinks = await getMenu();

const url = new URL(Astro.request.url);
const currentPath = normalizeNavPath(url.pathname);
---

<header id="main-header" class="site-header">
	<div class="header-container">
		<div class="header-content">
			<a
				href={getNavLink("/")}
				class="header-logo"
				aria-current={currentPath === "/" ? "page" : false}
			>
				{siteInfo.title}
			</a>
			<nav id="desktop-nav" class="desktop-nav" aria-label="Main navigation">
				{menuLinks.map((link, index) => {
					const isActive = currentPath === normalizeNavPath(link.path);
					return (
						<a
							href={link.path}
							class={`nav-link ${isActive ? 'active' : ''}`}
							aria-current={isActive ? "page" : false}
							data-astro-prefetch
						>
							{link.title}
						</a>
					);
				})}
			</nav>
			<div class="header-actions">
				<a
					href={getNavLink("/rss.xml")}
					class="rss-link"
					aria-label="RSS Feed"
					title="RSS Feed"
				>
					<Icon name={"rss"} class="rss-icon" aria-hidden="true" />
				</a>
				<Search />
				<ThemeIcon />
				<button
					id="toggle-navigation-menu"
					class="mobile-menu-btn"
					type="button"
					aria-label="Toggle menu"
					aria-expanded="false"
				>
					<Icon name={"menu"} class="menu-icon" aria-hidden="true" />
					<Icon name={"close"} class="close-icon" aria-hidden="true" />
				</button>
			</div>
		</div>
		<nav id="navigation-menu" class="nav-menu" aria-label="Mobile menu">
			{
				menuLinks.map((link) => {
					const isActive = currentPath === normalizeNavPath(link.path);
					return (
						<a
							href={link.path}
							class={`nav-link ${isActive ? 'active' : ''}`}
							aria-current={isActive ? "page" : false}
							data-astro-prefetch
						>
							{link.title}
						</a>
					);
				})
			}
		</nav>
	</div>
</header>

<style>
	.site-header {
		border-bottom: 1px solid var(--color-border);
		padding: 1.25rem 0;
		font-family: var(--font-mono), var(--font-sans), ui-monospace, monospace;
		background-color: var(--color-bgColor);
	}

	.header-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	.header-content {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 2rem;
		flex-wrap: wrap;
	}

	.header-logo {
		font-size: 1rem;
		font-weight: 400;
		text-decoration: none;
		color: var(--color-textColor);
		flex-shrink: 0;
	}

	.header-logo:hover {
		color: var(--color-accent);
	}

	.desktop-nav {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		flex: 1;
		justify-content: center;
		flex-wrap: nowrap;
		min-width: 0;
		overflow-x: auto;
		scrollbar-width: none; /* Firefox */
		-ms-overflow-style: none; /* IE and Edge */
	}

	.desktop-nav::-webkit-scrollbar {
		display: none; /* Chrome, Safari, Opera */
	}

	.desktop-nav .nav-link {
		text-decoration: none;
		color: var(--color-textColor);
		padding: 0.375rem 0.75rem;
		font-size: 0.875rem;
		font-weight: 400;
		white-space: nowrap;
		display: inline-flex;
		align-items: center;
		transition: all 0.15s ease;
		position: relative;
	}

	/* Add separator between links */
	.desktop-nav .nav-link:not(:last-child)::after {
		content: "|";
		color: var(--color-textColor);
		opacity: 0.25;
		margin-left: 0.75rem;
		display: inline-block;
		font-weight: 300;
		pointer-events: none;
	}

	.desktop-nav .nav-link:hover {
		color: var(--color-accent);
	}

	.desktop-nav .nav-link.active {
		color: var(--color-accent);
		background-color: color-mix(in srgb, var(--color-accent) 20%, transparent);
		border-radius: 6px;
		font-weight: 500;
	}

	.header-actions {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		flex-shrink: 0;
	}

	.rss-link {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 2.5rem;
		height: 2.5rem;
		color: var(--color-textColor);
		text-decoration: none;
		transition: color 0.15s ease;
		flex-shrink: 0;
		opacity: 0.8;
	}

	.rss-link:hover {
		color: var(--color-accent);
		opacity: 1;
	}

	.rss-icon {
		width: 1.25rem;
		height: 1.25rem;
	}

	.mobile-menu-btn {
		display: none;
		background: none;
		border: 1px solid var(--color-border);
		border-radius: 4px;
		padding: 0.5rem;
		cursor: pointer;
		width: 2.5rem;
		height: 2.5rem;
	}

	.mobile-menu-btn .close-icon {
		display: none;
	}

	.mobile-menu-btn[aria-expanded="true"] .menu-icon {
		display: none;
	}

	.mobile-menu-btn[aria-expanded="true"] .close-icon {
		display: block;
	}

	.nav-menu {
		display: none;
		flex-direction: column;
		gap: 0.5rem;
		margin-top: 1rem;
		padding-top: 1rem;
		border-top: 1px solid var(--color-border);
	}

	.nav-menu .nav-link {
		padding: 0.5rem 0;
		color: var(--color-textColor);
		text-decoration: none;
		font-size: 0.875rem;
		font-weight: 400;
	}

	.nav-menu .nav-link:hover {
		color: var(--color-accent);
	}

	.nav-menu .nav-link.active {
		color: var(--color-accent);
		background-color: color-mix(in srgb, var(--color-accent) 20%, transparent);
		border-radius: 6px;
		padding: 0.5rem 0.75rem;
		font-weight: 500;
	}

	.site-header.menu-open .nav-menu {
		display: flex;
	}

	@media (max-width: 768px) {
		.desktop-nav {
			display: none;
		}

		.mobile-menu-btn {
			display: block;
		}
	}
</style>

<script>
	const toggleButton = document.getElementById("toggle-navigation-menu");
	const navMenu = document.getElementById("navigation-menu");
	const mainHeader = document.getElementById("main-header");

	if (toggleButton && navMenu && mainHeader) {
		// Toggle menu on button click
		toggleButton.addEventListener("click", () => {
			const isOpen = mainHeader.classList.toggle("menu-open");
			toggleButton.setAttribute("aria-expanded", isOpen.toString());
		});

		// Close menu when clicking outside
		document.addEventListener("click", (event) => {
			const target = event.target as Node;
			if (
				mainHeader.classList.contains("menu-open") &&
				!toggleButton.contains(target) &&
				!navMenu.contains(target)
			) {
				mainHeader.classList.remove("menu-open");
				toggleButton.setAttribute("aria-expanded", "false");
			}
		});
	}
</script>
